#!/bin/bash

set -e  # –ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∏ –∫–ª—é—á–µ–π
mkdir -p certs
cd certs

echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è certs —Å–æ–∑–¥–∞–Ω–∞."

# –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è Root CA
openssl genrsa -out ca_root.key 4096
echo "üîë –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è Root CA —Å–æ–∑–¥–∞–Ω: ca_root.key"

# –°–æ–∑–¥–∞—ë–º —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è Root CA
openssl req -x509 -new -nodes \
  -key ca_root.key \
  -sha256 \
  -days 3650 \
  -out ca_root.crt \
  -subj "/CN=My Test CA/O=MyOrg/OU=Dev"
echo "üìÑ –°–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Root CA —Å–æ–∑–¥–∞–Ω: ca_root.crt"

# –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
openssl genrsa -out server.key 2048
echo "üîê –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Å–µ—Ä–≤–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω: server.key"

# –°–æ–∑–¥–∞—ë–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
openssl req -new \
  -key server.key \
  -out server.csr \
  -subj "/CN=my.server.local/O=MyOrg/OU=Services"
echo "üìë –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å–µ—Ä–≤–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω: server.csr"

# –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Root CA
openssl x509 -req \
  -in server.csr \
  -CA ca_root.crt \
  -CAkey ca_root.key \
  -CAcreateserial \
  -out server.crt \
  -days 365 \
  -sha256
echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–¥–ø–∏—Å–∞–Ω Root CA: server.crt"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
openssl verify -CAfile ca_root.crt server.crt
echo "üîç –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω."

echo "üéâ –í—Å–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ –∫–ª—é—á–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ certs/"

